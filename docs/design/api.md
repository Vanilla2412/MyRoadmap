# API Design

## 1. Overview

- **Protocol**: GraphQL
- **Service**: AWS AppSync
- **Authorization**: Amazon Cognito User Pools (JWT)
- **Schema Source**: Auto-generated by Amplify Gen 2 based on `docs/design/database.md`.

## 2. Authorization Strategy

- **Default Mode**: `AMAZON_COGNITO_USER_POOLS`
- **Rule**: `allow.owner()`
  - **Create**: Allowed for any authenticated user. The `owner` field is automatically populated with the user's ID (`sub`).
  - **Read**: Allowed only if `owner` field matches the caller's identity.
  - **Update**: Allowed only if `owner` field matches the caller's identity.
  - **Delete**: Allowed only if `owner` field matches the caller's identity.

## 3. GraphQL Operations

### 3.1 Queries (Read Operations)

#### `getTask(id: ID!)`

- **Description**: Fetch a single task by ID.
- **Auth**: Owner only.
- **Response**: `Task` object or null.

#### `listTasks(filter: ModelTaskFilterInput, limit: Int, nextToken: String)`

- **Description**: List all tasks belonging to the signed-in user.
- **Auth**: Owner only.
- **Pagination**: Supported via `limit` (default usually 100) and `nextToken`.

#### `listTasksByStatus(status: TaskStatus!, sortDirection: ModelSortDirection)`

- **Description**: Query using the `StatusIndex` GSI.
- **Use Case**: Filtering "IN_PROGRESS" tasks on the dashboard.

#### `listTasksByDueDate(dueDate: AWSDate!, sortDirection: ModelSortDirection)`

- **Description**: Query using the `DueDateIndex` GSI.
- **Use Case**: Sorting tasks by urgency.

### 3.2 Mutations (Write Operations)

#### `createTask(input: CreateTaskInput!)`

- **Description**: Create a new task.
- **Input Fields**: `title` (required), `status`, `priority`, `dueDate`, `category`, `description`.
- **Auto-filled**: `id`, `owner`, `createdAt`, `updatedAt`.

#### `updateTask(input: UpdateTaskInput!)`

- **Description**: Modify an existing task.
- **Input Fields**: `id` (required), plus any fields to change.
- **Condition**: Must be the owner.

#### `deleteTask(input: DeleteTaskInput!)`

- **Description**: Remove a task.
- **Input Fields**: `id` (required).
- **Condition**: Must be the owner.

### 3.3 Subscriptions (Real-time)

#### `onCreateTask(filter: ModelSubscriptionTaskFilterInput)`

- **Description**: Real-time updates when a task is created.
- **Scope**: Owner only (User receives events only for their own data).

#### `onUpdateTask(filter: ModelSubscriptionTaskFilterInput)`

- **Description**: Real-time updates when a task is modified.

#### `onDeleteTask(filter: ModelSubscriptionTaskFilterInput)`

- **Description**: Real-time updates when a task is deleted.

## 4. Error Handling

- **401 Unauthorized**: Missing or invalid JWT token.
- **403 Forbidden**: Valid token but accessing a resource owned by another user.
- **400 Bad Request**: Invalid input (e.g., missing required field, wrong type).
